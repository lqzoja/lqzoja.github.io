

<!-- post | photo -->
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8">

<title>线段树入门详解 | SW_Wind&#39;s blog</title>

<script src="/js/jquery-2.0.3.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css">
<!-- Mathjax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<!-- Valine -->
<script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/js/Valine.min.js"></script>
  </head>
  <body>
    <header>
      <div style="background-image: url(/img/author.jpg)" class="author_img"></div>
<div class="blog-title">
	<p class="title">SW_Wind&#39;s blog</p>
	<p class="subtitle">病名は愛だった</p>
</div>
<ul class="headerlinks">

  <li><a href="/">首页</a></li>

  <li><a href="/about">关于</a></li>

  <li><a href="/archives">归档</a></li>

  <li><a href="/tags">标签</a></li>

  <li><a href="/categories">分类</a></li>

</ul>
    </header>
    <div class="container">
      <div class="main">
        <div class="post">
  <article>
    <div class="artc-title">
      <h1>线段树入门详解</h1>
      <p><span class="time-icon">2017-03-12</span><span class="author-icon">SW_Wind</span></p>
    </div>
    <div class="artc">
      
        <div class="toc-father">
          <strong class="toc-title">文章目录</strong>
          
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模板"><span class="toc-number">2.</span> <span class="toc-text">模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后"><span class="toc-number">3.</span> <span class="toc-text">最后</span></a></li></ol>
          
        </div>
      
      <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>线段树其实就是一个超级简单的数据结构。<br>就是把一个序列搞出若干个区间，在询问和修改时改一下区间就行了。<br>比方说某节点表示[1, n]的区间，那么该节点的左子树就表示[1, (n+1)/2]的区间，右子树就表示[(n+1)/2+1, n]的区间。<br>然后每个节点维护一下该区间内的目标对象（sum、max等）就行了，<br>这样可以在n<sup>2</sup>的时间内建树，在log(n)的时间内完成查询操作。<br>注意到线段树是颗二叉树，所以每个节点的左儿子可以表示为x*2(位运算简化为x&lt;&lt;1)，右儿子为x*2+1(x&lt;&lt;1|1)<br>注意在查询的时候如果要修改的刚好就是该节点的区间，<br>那么可以为这个节点打一个flag（俗称Lazy标记），而不必把他下面的节点全部更新（不然是O（n）的了）。</p>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>下面就是模板了，但是希望大家先不看模板打一遍，再与模板校对并优化<br>先是每个节点的结构体：<br><a id="more"></a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="keyword">struct</span> node&#123;</div><div class="line">	<span class="keyword">int</span> l, r, sum, mx, lazy; <span class="comment">// l, r: 左右边界，sum、mx: 最大值 lazy只是个标记</span></div><div class="line">&#125;tr[N&lt;&lt;<span class="number">2</span>]; <span class="comment">// 节点要开长度的四倍大小</span></div></pre></td></tr></table></figure>
<p>建树：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span>&#123;</div><div class="line">	tr[x].l = l, tr[x].r = r;</div><div class="line">	<span class="keyword">if</span>(l == r)&#123;</div><div class="line">		tr[x].sum = tr[x].mx = a[l];</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> mid = tr[x].l + tr[x].r &gt;&gt; <span class="number">1</span>;</div><div class="line">	build(x&lt;&lt;<span class="number">1</span>, l, mid);</div><div class="line">	build(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, r);</div><div class="line">	push_up(x); <span class="comment">// 更新x的值</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后是push_up的内容：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">push_up</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">	tr[x].sum = tr[x&lt;&lt;<span class="number">1</span>].sum + tr[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>].sum + a[x]; <span class="comment">// 更新sum</span></div><div class="line">	tr[x].mx = max(tr[x&lt;&lt;<span class="number">1</span>].mx, tr[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>].mx); <span class="comment">// 更新max</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着是查询：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">asksum</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span>&#123;</div><div class="line">	push_down(x); <span class="comment">// 这步后来会讲到，下传标记</span></div><div class="line">	<span class="keyword">if</span>(tr[x].l == l &amp;&amp; tr[x].r == r) <span class="keyword">return</span> tr[x].sum;</div><div class="line">	<span class="keyword">int</span> mid = tr[x].l + tr[x].r &gt;&gt; <span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span>(r &lt;= mid) <span class="keyword">return</span> asksum(x&lt;&lt;<span class="number">1</span>, l, r); <span class="comment">// 若果询问的区间明显在节点区间的左半边，那么去问节点的左子树</span></div><div class="line">	<span class="keyword">if</span>(l &gt; mid) <span class="keyword">return</span> asksum(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, l, r); <span class="comment">// 如果在右边就去问右子树</span></div><div class="line">	<span class="keyword">return</span> asksum(x&lt;&lt;<span class="number">1</span>, l, mid) + asksum(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, r); <span class="comment">// 不然两个都要问</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">askmax</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span>&#123; <span class="comment">// 这个和上面一个基本一样</span></div><div class="line">	push_down(x);</div><div class="line">	<span class="keyword">if</span>(tr[x].l == l &amp;&amp; tr[x].r == r) <span class="keyword">return</span> tr[x].mx;</div><div class="line">	<span class="keyword">int</span> mid = tr[x].l + tr[x].r &gt;&gt; <span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span>(r &lt;= mid) <span class="keyword">return</span> askmax(x&lt;&lt;<span class="number">1</span>, l, r);</div><div class="line">	<span class="keyword">if</span>(l &gt; mid) <span class="keyword">return</span> askmax(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, l, r);</div><div class="line">	<span class="keyword">return</span> max(askmax(x&lt;&lt;<span class="number">1</span>, l, mid), askmax(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, r));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后是区间加的操作：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> l, <span class="keyword">int</span> r, <span class="keyword">int</span> v)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(tr[x].l == l &amp;&amp; tr[x].r == r)&#123;</div><div class="line">		tr[x].lazy += val; <span class="comment">// 这标记就是说，他的儿子都要加这么多，但是懒得算下去了</span></div><div class="line">		tr[x].sum += val*(tr[x].r - tr[x].l + <span class="number">1</span>);</div><div class="line">		tr[x].mx += val;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> mid = tr[x].l + tr[x].r &gt;&gt; <span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span>(r &lt;= mid) update(x&lt;&lt;<span class="number">1</span>, l, r, val);</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(l &gt; mid) update(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, l, r, val);</div><div class="line">	<span class="keyword">else</span> update(x&lt;&lt;<span class="number">1</span>, l, mid, val), update(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mid+<span class="number">1</span>, r, val);</div><div class="line">	push_up(x); <span class="comment">// 更新x的值</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后就是标记下传啦！</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">push_down</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(!tr[x].lazy) <span class="keyword">return</span>; <span class="comment">// 没有标记就返回</span></div><div class="line">	<span class="keyword">if</span>(tr[x].l)&#123; <span class="comment">// 有左儿子</span></div><div class="line">		tr[tr[x].l].lazy += tr[x].lazy;</div><div class="line">		tr[tr[x].l].sum += tr[x].lazy*(tr[x].r - tr[x].l + <span class="number">1</span>);</div><div class="line">		tr[tr[x].l].mx += tr[x].lazy;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span>(tr[x].r)&#123; <span class="comment">// 有右儿子</span></div><div class="line">		tr[tr[x].r].lazy += tr[x].lazy;</div><div class="line">		tr[tr[x].r].sum += tr[x].lazy*(tr[x].r - tr[x].l + <span class="number">1</span>);</div><div class="line">		tr[tr[x].r].mx += tr[x].lazy;</div><div class="line">	&#125;</div><div class="line">	tr[x].lazy = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>看完了之后就有一大波水题在等着你！<br>就算看不懂照题解多打几遍慢慢就懂了的！<br>刷题才是王道！<br>GL&amp;HF</p>

    </div>
    <div class="article-catetags">

<div class="categories-icon">
  <a class="article-category-link" href="/categories/教程/">教程</a>
</div>


  <div class="tags-icon">
  
    <a href="/tags/线段树/">线段树</a>
  </div>

</div>

  </article>
</div>  

        
          
	<div class="this-is-a-very-long-class-name" id="comments"></div>
	<script type="text/javascript">
		new Valine({
            av: AV, 
            el: '.this-is-a-very-long-class-name',
            app_id: 'h3fpaex2rIrXIA4BXkhAT9H0-gzGzoHsz',
            app_key: 'Ar7Yt5v6dLnd0v7G3reEnXkL',
            placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
            notify: true,
  			verify: true
        });
	</script>

        
      </div>
      <aside class="sidebar">

  <div class="hitokoto sidebar-item">
  <p class="sidebar-title">一言</p>
  <div class="hitokoto-text" id="yiyan-text">Loading...</div>
  <div class="hitokoto-author" id="yiyan-author"></div>
  <script type="text/javascript">;(function(){var s="ac";$.get("https://sslapi.hitokoto.cn/?c="+s[Math.floor(Math.random()*s.length)],function(data){var yy=JSON.parse(data);$('#yiyan-text').html(yy.hitokoto);$('#yiyan-author').html('《'+yy.from+'》');})})();</script>
</div>

  <div class="linkslist sidebar-item">
  <p class="sidebar-title">友情链接</p>
  <div class="sidebar-main">
    <ul>
      <li><a href="https://shenzhebei.github.io/" target="_blank">SHENZHEBEI</a></li>
      <li><a href="http://blog.csdn.net/largecub233/" target="_blank">largecub233</a></li>
      <li><a href="http://blog.csdn.net/Fop_zz/" target="_blank">Fop_zz</a></li>
      <li><a href="http://blog.csdn.net/jzq233jzq/" target="_blank">jzq233jzq</a></li>
      <li><a href="https://zhzh2001.github.io/" target="_blank">zhzh2001</a></li>
      <li><a href="http://blog.csdn.net/mdnd1234/" target="_blank">mdnd</a></li>
      <li><a href="http://www.bilibili.com/" target="_blank">bilibili(乱入)</a></li>
      <li><a href="http://blog.csdn.net/zhouyuyang233/" target="_blank">zhouyuyang233</a></li>
      <li><a href="https://littleredstar.github.io/" target="_blank">black_moon</a></li>
      <li><a href="https://problem233.github.io/" target="_blank">problem233</a></li>
      <li><a href="http://blog.csdn.net/nn020701/" target="_blank">nn020701</a></li>
    </ul>
  </div>
</div>

</aside>
    </div>
    <footer>
      <p>Powered by <a href="https://hexo.io/" target="view_window">Hexo</a> and theme by <a href="https://github.com/swwind/hacker" target="view_window">Hacker</a></p>
    </footer>
    <!-- It must be a script element -->
  </body>
</html>

